name: Deploy Dashboard to Production

on:
  push:
    branches:
      - main
    paths:
      - 'dashboard/**'
      - '.github/workflows/deploy-dashboard.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - demo
      restart_server:
        description: 'Restart server after deployment'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    name: Build & Deploy Dashboard
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: üõéÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json

      - name: üì• Install Dependencies
        working-directory: dashboard
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: üî® Build Dashboard
        working-directory: dashboard
        run: |
          npm run build
          
      - name: ‚úÖ Verify Build
        working-directory: dashboard
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå Build failed - output directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful"
          echo "üìä Files: $(find out -type f | wc -l)"
          echo "üì¶ Size: $(du -sh out | cut -f1)"
          
      - name: üìä Build Report
        working-directory: dashboard
        run: |
          echo "## üöÄ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Files | $(find out -type f | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "| Size | $(du -sh out | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Time | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | ${{ env.NODE_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY

      - name: üîë Setup SSH Key
        if: github.event_name != 'pull_request'
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          if [ -n "$SSH_PRIVATE_KEY" ]; then
            mkdir -p ~/.ssh
            echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            if [ -n "$SSH_KNOWN_HOSTS" ]; then
              echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
              chmod 644 ~/.ssh/known_hosts
            fi
            echo "‚úÖ SSH key configured"
          else
            echo "‚ö†Ô∏è SSH key not configured, deployment will be skipped"
          fi
          
      - name: üíæ Create Remote Backup
        if: github.event_name != 'pull_request'
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          if [ -n "$REMOTE_HOST" ] && [ -n "$REMOTE_USER" ] && [ -n "$REMOTE_PATH" ]; then
            BACKUP_NAME="dashboard-backup-$(date +%Y%m%d-%H%M%S)"
            ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
              "cd ${REMOTE_PATH} && [ -d server/dashboard-dist ] && tar -czf backups/${BACKUP_NAME}.tar.gz server/dashboard-dist || mkdir -p backups"
            echo "‚úÖ Backup created: ${BACKUP_NAME}.tar.gz"
          else
            echo "‚ö†Ô∏è Deployment not configured, skipping backup"
          fi

      - name: üöÄ Deploy to Production
        if: github.event_name != 'pull_request'
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          REMOTE_DASHBOARD_PATH: ${{ secrets.REMOTE_DASHBOARD_PATH }}
        run: |
          if [ -n "$REMOTE_HOST" ] && [ -n "$REMOTE_USER" ] && [ -n "$REMOTE_DASHBOARD_PATH" ]; then
            rsync -avz --delete \
              -e "ssh -p ${REMOTE_PORT} -o StrictHostKeyChecking=no" \
              --exclude 'node_modules' \
              --exclude '.next' \
              --exclude '.git' \
              dashboard/out/ \
              ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_DASHBOARD_PATH}/
            echo "‚úÖ Dashboard deployed successfully"
          else
            echo "‚ö†Ô∏è Deployment not configured, skipping deployment (build artifacts available)"
          fi

      - name: üîÑ Restart Server
        if: github.event_name != 'pull_request' && (github.event.inputs.restart_server == 'true' || github.event_name == 'push')
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          SERVER_SERVICE: ${{ secrets.SERVER_SERVICE || 'systracker' }}
          USE_PM2: ${{ secrets.USE_PM2 || 'false' }}
          PM2_APP_NAME: ${{ secrets.PM2_APP_NAME || 'systracker' }}
        run: |
          if [ -n "$REMOTE_HOST" ] && [ -n "$REMOTE_USER" ]; then
            if [ "$USE_PM2" = "true" ]; then
              ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} "pm2 restart ${PM2_APP_NAME}"
              echo "‚úÖ Server restarted via PM2"
            else
              ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} "sudo systemctl restart ${SERVER_SERVICE}"
              echo "‚úÖ Server restarted via systemd"
            fi
          else
            echo "‚ö†Ô∏è Remote server not configured, skipping restart"
          fi

      - name: ‚úÖ Verify Deployment
        if: github.event_name != 'pull_request'
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          REMOTE_DASHBOARD_PATH: ${{ secrets.REMOTE_DASHBOARD_PATH }}
        run: |
          if [ -n "$REMOTE_HOST" ] && [ -n "$REMOTE_USER" ] && [ -n "$REMOTE_DASHBOARD_PATH" ]; then
            FILE_COUNT=$(ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
              "find ${REMOTE_DASHBOARD_PATH} -type f | wc -l")
            DIR_SIZE=$(ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
              "du -sh ${REMOTE_DASHBOARD_PATH} | cut -f1")
            
            echo "## üìä Deployment Verification" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Files Deployed | ${FILE_COUNT} |" >> $GITHUB_STEP_SUMMARY
            echo "| Directory Size | ${DIR_SIZE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Server | ${REMOTE_HOST} |" >> $GITHUB_STEP_SUMMARY
            echo "| Deploy Time | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Remote server not configured, skipping verification"
          fi

      - name: üì¢ Notify Slack
        if: success() && github.event_name != 'pull_request'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST $SLACK_WEBHOOK \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\":\"üöÄ SysTracker Dashboard deployed to ${{ github.event.inputs.environment || 'production' }}\",
                \"attachments\":[{
                  \"color\":\"good\",
                  \"fields\":[
                    {\"title\":\"Environment\",\"value\":\"${{ github.event.inputs.environment || 'production' }}\",\"short\":true},
                    {\"title\":\"Deployed By\",\"value\":\"${{ github.actor }}\",\"short\":true},
                    {\"title\":\"Commit\",\"value\":\"${{ github.sha }}\",\"short\":true},
                    {\"title\":\"Branch\",\"value\":\"${{ github.ref_name }}\",\"short\":true}
                  ]
                }]
              }"
          else
            echo "Slack webhook not configured, skipping notification"
          fi

      - name: üì¢ Notify Discord
        if: success() && github.event_name != 'pull_request'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -X POST $DISCORD_WEBHOOK \
              -H 'Content-Type: application/json' \
              -d "{
                \"content\":\"üöÄ **SysTracker Dashboard Deployed**\",
                \"embeds\":[{
                  \"color\":5832650,
                  \"fields\":[
                    {\"name\":\"Environment\",\"value\":\"${{ github.event.inputs.environment || 'production' }}\",\"inline\":true},
                    {\"name\":\"Deployed By\",\"value\":\"${{ github.actor }}\",\"inline\":true},
                    {\"name\":\"Commit\",\"value\":\"${{ github.sha }}\",\"inline\":false}
                  ],
                  \"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
                }]
              }"
          else
            echo "Discord webhook not configured, skipping notification"
          fi

      - name: ‚ùå Rollback on Failure
        if: failure() && github.event_name != 'pull_request'
        env:
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          REMOTE_PATH: ${{ secrets.REMOTE_PATH }}
        run: |
          if [ -n "$REMOTE_HOST" ] && [ -n "$REMOTE_USER" ] && [ -n "$REMOTE_PATH" ]; then
            echo "‚ö†Ô∏è Deployment failed, attempting rollback..."
            LATEST_BACKUP=$(ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
              "cd ${REMOTE_PATH}/backups && ls -t dashboard-backup-*.tar.gz | head -1")
            if [ -n "$LATEST_BACKUP" ]; then
              ssh -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
                "cd ${REMOTE_PATH} && tar -xzf backups/${LATEST_BACKUP}"
              echo "‚úÖ Rolled back to: ${LATEST_BACKUP}"
            else
              echo "‚ùå No backup found for rollback"
            fi
          else
            echo "‚ö†Ô∏è Remote server not configured, skipping rollback"
          fi

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: failure()
    steps:
      - name: üì¢ Send Failure Alert
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST $SLACK_WEBHOOK \
              -H 'Content-Type: application/json' \
              -d "{
                \"text\":\"‚ö†Ô∏è SysTracker Dashboard deployment FAILED\",
                \"attachments\":[{
                  \"color\":\"danger\",
                  \"fields\":[
                    {\"title\":\"Environment\",\"value\":\"${{ github.event.inputs.environment || 'production' }}\",\"short\":true},
                    {\"title\":\"Failed By\",\"value\":\"${{ github.actor }}\",\"short\":true},
                    {\"title\":\"Workflow\",\"value\":\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",\"short\":false}
                  ]
                }]
              }"
          else
            echo "Slack webhook not configured, skipping failure alert"
          fi
