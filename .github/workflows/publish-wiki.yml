name: Publish Documentation Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/publish-wiki.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Markdown Files
        run: |
          echo "Validating Markdown syntax..."
          find docs -name "*.md" -type f 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              echo "✓ Found: $file"
            fi
          done
          echo "✓ Markdown validation passed"

  update-wiki:
    runs-on: ubuntu-latest
    needs: validate-docs
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Update Wiki
        run: |
          mkdir -p wiki
          cd wiki
          
          # Try to clone existing wiki
          if git clone --depth 1 "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" . 2>/dev/null; then
            echo "Wiki repository cloned"
          else
            echo "Initializing new wiki repository"
            git init
            git config user.email "action@github.com"
            git config user.name "GitHub Action"
            git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
            
            # Create initial Home page
            echo "# SysTracker Documentation Wiki" > Home.md
            echo "" >> Home.md
            echo "Welcome to the SysTracker documentation!" >> Home.md
          fi
          
          # Copy README as Home
          cp ../README.md Home.md
          
          # Copy all markdown files from docs
          if [ -d "../docs" ]; then
            cp -r ../docs/* . 2>/dev/null || true
          fi
          
          # Create sidebar
          cat > _Sidebar.md << 'SIDEBAR'
          # Documentation
          
          ## Getting Started
          - [[Home|Home]]
          - [[Installation|README]]
          
          ## Features
          - [[Dashboard Features|FEATURES_AND_STATUS]]
          - [[Implementation Status|IMPLEMENTATION_COMPLETE_SUMMARY]]
          
          ## Guides
          - [[Architecture|docs/architecture]]
          - [[Deployment|docs/deployment]]
          
          ---
          [GitHub](https://github.com/${{ github.repository }}) | [Issues](https://github.com/${{ github.repository }}/issues)
          SIDEBAR

          # Commit and push
          git add -A
          
          if git diff --quiet --cached; then
            echo "No changes to wiki"
            exit 0
          fi
          
          git commit -m "docs: sync documentation from main repository"
          
          # Try to push
          if git push -u origin master 2>/dev/null; then
            echo "✓ Wiki updated (master branch)"
          elif git push -u origin main 2>/dev/null; then
            echo "✓ Wiki updated (main branch)"
          else
            echo "⚠ Wiki push skipped (may need manual initialization)"
            exit 0
          fi
